---
title: "Smoke Analysis Report for XXX Rx Fire"
author: "Jeremy Ash"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
geometry: margin=0.25in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## SPATIAL
library(sp)
library(rgeos)
library(raster)
library(rgdal)
library(maptools)
library(ggmap)

## DATA MANAGEMENT
library(tidyverse)
library(skimr)
library(patchwork)
library(readxl)
# library(zoo)

## PLOTTING
library(scales)
library(units)
library(viridis)
library(extrafont)
library(gtable)
library(grid)
library(ggimage)
library(gridExtra)
library(knitr)
library(kableExtra)
library(egg)

## SMOKE DATA
library(PWFSLSmoke)
library(MazamaSpatialUtils)
```


```{r fire_info, include = FALSE}
#############################################################################
## pull monitors near fire
#############################################################################

# number of previous days
n_hrs <- 96

#rx fire
fire_info <- tibble(lon = -82.22618525756064, 
                    lat = 39.53743368404867,
                    name = "Wayne NF Rx Fire")

# pull hourly data within 100 km of rx fire  and the last n_days hours
airnow <- airnow_loadLatest() %>% 
  monitor_subsetByDistance(fire_info$lon, fire_info$lat, radius = 100) 

airnow$data <- airnow$data %>% 
  slice(-(1:(n()-n_hrs)))

# 
# # check what the dates are...data are for the previous 10 days on an hourly basis
# airnow_dat <- airnow[["data"]] 
# range(airnow_dat$datetime)

# get number of monitors 
n_mons <- length(unique(airnow$meta$monitorID))


# get max and prep for plotting
max_dat <- airnow$data %>% 
  gather(monitorID, pm_val, -1) %>% 
  group_by(monitorID) %>% 
  summarise(max_pm = max(pm_val, na.rm = TRUE)) %>% 
  ungroup() %>% 
  left_join(., airnow$meta, by = "monitorID") %>%
  select(monitorID, max_pm, longitude, latitude) %>% 
  mutate(aqi_col = aqiColors(max_pm),
         aqi_cat = cut(max_pm, 
                       breaks = AQI$breaks_24,
                       labels = AQI$names))


# calculate mean and prep data for plotting
mon_dailyMean_list <- monitor_dailyStatistic(airnow, FUN = get("mean"), 
                                        dayStart = "midnight", 
                                        na.rm = TRUE, 
                                        minHours = 18)

mon_names <- mon_dailyMean_list[[1]]$siteName

mon_mean_df <- mon_dailyMean_list[[2]] 
colnames(mon_mean_df)[2:(2+length(mon_names)-1)] <- mon_names
mon_mean_df <- mon_mean_df %>% 
  gather(mon_name, pm_val, -1) %>% 
  mutate(aqi_col = aqiColors(pm_val),
         aqi_cat = cut(pm_val, 
                       breaks = AQI$breaks_24,
                       labels = AQI$names))

# read aqi table
aqi_tab <- read_csv("../data/aqi_table.csv")

```

## Recent Air Quality in Area of `r fire_info$name` 

This report documents the recent air quality, weather forecast and smoke analysis for the `r fire_info$name` fire. Shown immediately below is the recent air quality index (AQI) for nearby monitors. The map shows the location of the fire and the highest hourly recorded PM$_{2.5}$ concentration over the past 3 days. The bar plots show the average daily PM$_{2.5}$ concentrations for each nearby monitor over the past 3 days. Both plots are color-coded according to the AQI colors shown in the table below.

```{r fire_map_aqi, include = TRUE, echo = FALSE, message = FALSE}

# set up google API for ggmap
api <- readLines("C:/Users/jash/Documents/projects/smoke_report/google.api")
register_google(key = api)

fire_icon <- tibble(x = fire_info$lon,
                        y = fire_info$lat,
                        image = "../icons/redFlame.png")

fire_map_info <- get_map(location = c(fire_info$lon, fire_info$lat),
                    maptype = "terrain",
                    zoom = 9)

fire_map <- ggmap(fire_map_info, extent = "device") +
  geom_image(aes(x = x, y = y, image = image), data = fire_icon) +
  geom_point(aes(x = longitude, y = latitude, color = aqi_cat), size = 3, show.legend = FALSE, data = max_dat) +
  scale_color_manual(values = max_dat$aqi_col)



# recent AQI values at nearby monitors
daily_aqi_plot <- ggplot(aes(x = datetime, y = pm_val, group = mon_name), data = mon_mean_df) +
  geom_bar(aes(fill = aqi_cat), stat = "identity", show.legend = FALSE) +
  scale_fill_manual(values = AQI$colors) +
  facet_wrap(~mon_name, ncol = 1) +
  labs(y = expression(PM[2.5]), x = NULL) +
  theme_minimal()


# aqi_table 
aqi_kable <- aqi_tab %>%
  mutate('Air Quality Index (AQI)' = cell_spec(c("Good", "Moderate", "USG", "Unhealthy", "Very Unhealthy", "Hazardous"), color = "black", bold = T, background = AQI$colors)) %>% 
  kable(escape = FALSE, linesep = "") %>%
  kable_styling(full_width = F, position = "left")


# 
grid.arrange(fire_map, daily_aqi_plot, nrow = 1)

aqi_kable




```
## Modeled Smoke Trajectories for `r fire_info$name` 
Below are the BlueSky modeling outputs for the fire. Each row of figures shows one day from the modeling runs and displays the average smoke conditions (top panel) and maximum smoke conditions (bottom panel). The average smoke conditions are helpful for comparing with the NAAQS to identify areas of concern for public health. The maximum smoke conditions show the highest concentration of PM$_{2.5}$ at each point in the modeling domain for that day. The maximum trajectory is useful for idnetifying potetnial impacts to visibility. 

__Smoke conditions on day one of the modeling run: 24 average (top) and maximum (bottom)__
```{r bluesky_maps_day_one, echo = FALSE, out.width="49%", out.height="20%",fig.show='hold',fig.align='center'}
## Modeled Smoke Trajectories `r fire_info$name` 

include_graphics(c("bluesky/day_one_ave.jpg", "bluesky/day_one_max.jpg"))
# day1_avg <- include_graphics("blueksy/day_one_ave.jpg")
# day2_avg <-
# 
# day1_max <-
# day2_max <- 
```

__Smoke conditions on day two of the modeling run: 24 average (top) and maximum (bottom)__
```{r bluesky_maps_day_two, echo = FALSE, caption = "caption", out.width="49%", out.height="20%",fig.show='hold',fig.align='center'}
## Modeled Smoke Trajectories `r fire_info$name` 

include_graphics(c("bluesky/day_two_ave.jpg", "bluesky/day_two_max.jpg"))
# day1_avg <- include_graphics("blueksy/day_one_ave.jpg")
# day2_avg <-
# 
# day1_max <-
# day2_max <- 
```


## Meterological Conditions  

```{r firepoker_link, echo = FALSE }



#############################################################################
## get firepoker link
#############################################################################

# get fire location
fire_loc <- fire_info %>% 
  select(-name)

# specify coordinates
coordinates(fire_loc) <- c("lon", "lat")
proj4string(fire_loc) <- CRS("+init=epsg:4326")

# transform to bbox CRS
fire_loc_3857 <- spTransform(fire_loc, CRS("+init=epsg:3857"))@coords

# bbox data: xmin, ymin, xmax, ymax
bbox_ctds <- c(fire_loc_3857[1] + -1016307,
               fire_loc_3857[2] - 489197,
               fire_loc_3857[1] - -1016307,
               fire_loc_3857[2] + 489197)

disp_brkpts <- c(0,40,60,100,150)


# create firepoker link
fp_url <- paste("https://www.weather.gov/dlh/firepoker?lat=",
                round(fire_info$lat, 3),
                "&lon=",
                round(fire_info$lon, 3),
                "&clat=",
                round(fire_info$lat, 3),
                "&clon=",
                round(fire_info$lon, 3),
                "&zoom=6&bbox=[",
                round(bbox_ctds[1], 3),
                ",",
                round(bbox_ctds[2], 3),
                ",",
                round(bbox_ctds[3], 3),
                ",",
                round(bbox_ctds[4], 3),
                "]&layers=FFFTTTTFFFT&fwf=F&dispersion=",
                paste(disp_brkpts, collapse = ","),
                sep = "")
```

The weather data shown below can be found [here](`r fp_url`). 

```{r met_data, echo=FALSE, out.width="100%", out.height="100%",fig.show='hold',fig.align='center'}
include_graphics("met_data.PNG")
```















